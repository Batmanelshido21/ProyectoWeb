/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojconfig","knockout","ojs/ojlogger"],(function(e,n,t){"use strict";function r(){this.Init()}function i(t,r){return function(i,o,a,s){var u=e.getExpressionEvaluator();return u?function(e,t,r,i){var o=i[e];if(!o){var a=n.expressionRewriting.preProcessBindings(e,t);o=r.createEvaluator("{"+a+"}").evaluate,i[e]=o}return o}(i,s,u,r)([o.$data||{},o,{$element:a}]):t(i,o,a,s)}}return oj.Object.createSubclass(r,oj.Object,"ComponentBinding.GlobalChangeQueue"),r.prototype.Init=function(){r.superclass.Init.call(this),this._trackers=[],this._queue=[]},r.prototype.registerComponentChanges=function(e){-1===this._trackers.indexOf(e)&&(this._trackers.push(e),this._delayTimer||(this._delayTimer=setTimeout(oj.Object.createCallback(this,this._deliverChangesImpl),1),this._delayPromise=new Promise(function(e){this._delayPromiseResolver=e}.bind(this))))},r.prototype.deliverChanges=function(){this._delayTimer&&clearTimeout(this._delayTimer),this._deliverChangesImpl()},r.prototype.getThrottlePromise=function(){return this._delayPromise||Promise.resolve()},r.prototype._deliverChangesImpl=function(){this._delayTimer=null,this._resolveDelayPromise();var e=this._trackers;this._trackers=[];for(var n=0;n<e.length;n++){var t=e[n];this._queue.push({tracker:t,changes:t.flushChanges()})}for(;this._queue.length>0;){var r=this._queue.shift();r.tracker.applyChanges(r.changes)}},r.prototype._resolveDelayPromise=function(){this._delayPromise&&(this._delayPromiseResolver(),this._delayPromiseResolver=null,this._delayPromise=null)},(new function(){var o=new WeakMap,a={},s={},u={},c=new r;function l(n){var t,r=e.getExpressionEvaluator();if(r){var i=r.createEvaluator(n).evaluate;return function(e,n){return i([e,e.$data||{},{$element:n}])}}try{t=new Function("$context","$element","with($context.$data||{}){with($context){return "+n+"}}")}catch(e){throw new Error(e.message+' in expression "'+n+'"')}return t}function d(e,n,t){if(!t)return e(n,t);var r,i=o,a=t._ojCacheScope||t;(r=i.get(a))||(r={},i.set(a,r));var s=r[n];return s||(s=e(n,t),r[n]=s),s}function p(e,n,t){var r=n.getBindingsString;if(r)return r.call(n,e,t);switch(e.nodeType){case 1:return e.getAttribute("data-bind");case 8:var i=e.nodeValue.match(/^\s*ko(?:\s+([\s\S]+))?\s*$/);return i?i[1]:null;default:return null}}this.install=function(){var e=n.bindingProvider,r=e.instance;if(!r.getBindingAccessors)return t.error("JET's Knockout bindings are not compatible with the current binding provider since it does not implement getBindingAccessors()"),this;var o={getWrapped:function(){return r}};e.instance=o;var c=[];return c.push("getBindingAccessors","nodeHasBindings","getBindings"),c.forEach((function(e){o[e]=function(e,t,r){var i="nodeHasBindings"===t;return function(o){if(i){var s=o.nodeType;if(1!==s&&8!==s)return!1}var u=r(t,e[t]),c=u?u.apply(e,arguments):null,l=a[t];if(null!=l){var d=arguments;l.forEach((function(t){var r=Array.prototype.slice.call(d);r.push(c,e),c=n.ignoreDependencies(t,null,r)}))}return c}}(r,e,(function(e,t){return"getBindingAccessors"!==e?t:function(e,t){return function(r,i){if(i._ojExtended){var o=p(r,t,i),a=o?function(e,t){return d((function(e){return l("{"+n.expressionRewriting.preProcessBindings(e,{valueAccessors:!0})+"}")}),e,t)}(o,i)(i,r):null;if(1===r.nodeType&&n.components.isRegistered(r.tagName.toLowerCase())){var s=e.call(t,r,i).component;s&&((a=a||{}).component=s)}return a}return e.call(t,r,i)}}(t,r)}))})),o.preprocessNode=function(e){var t=e.preprocessNode;return function(r){var i,o,a=null;return 1===r.nodeType&&(i=s[r.nodeName.toLowerCase()]),i||(i=t,a=e),i&&(o=n.ignoreDependencies(i,a,[r])),Array.isArray(o)&&(o=function(e,t){var r=n.bindingProvider.instance,i=t.slice(0),o=t[0],a=0,s=0;for(;a>=0;){var u=n.virtualElements.nextSibling(o);if(o!==e){var c=r.preprocessNode(o);Array.isArray(c)&&(i.splice.apply(i,[s,1].concat(c)),s+=c.length-1)}s+=1;var l=a+1;a=(o=u)?t.indexOf(o,l):-1,s+=a-l}return i}(r,o)),o}}(r),function(e){var n=e.nativeTemplateEngine.prototype,t="renderTemplateSource",r=n[t];n[t]=function(e,n,t,i){return r.call(this,e,n,t,i||document)}}(n),function(e){e.components.loaders.unshift({loadTemplate:function(n,t,r){if("string"==typeof t){var i=e.utils.parseHtmlFragment(t,document);e.components.defaultLoader.loadTemplate(n,i,r)}else r(null)}})}(n),function(e){var r,o=n.bindingProvider.instance;for(;o&&!r;){var a=o.parseBindingsString;a?(r=!0,o.parseBindingsString=i(a.bind(o),e)):o=o.getWrapped?o.getWrapped():null}r||t.error("Unable to patch KO expression evaluation implementation. If you have a custom binding provider, make sure it implements the getWrapped() method that returns the default binding provider instance.")}(u),this},this.addPostprocessor=function(e){Object.keys(e).forEach((function(n){a[n]=a[n]||[],a[n].push(e[n])}))},this.registerPreprocessor=function(e,n){s[e]=n},this.getBindingsString=function(e,n,t){return p(e,n,t)},this.extendBindingContext=function(e,n,t,r,i){var o={$current:n,$root:void 0,$parent:void 0,$parents:void 0};return t&&(o[t]=n),r&&(o[r]=n),e?o=e.extend(o):o.$data={},Object.defineProperty(o,"_ojCacheScope",{value:i}),Object.defineProperty(o,"_ojExtended",{value:!0}),o},this.createBindingExpressionEvaluator=function(n,t){if(t._ojExtended)return l(n);var r,i=e.getExpressionEvaluator();if(i){var o=i.createEvaluator(n).evaluate;return function(e){return o([e.$data||{},e])}}try{r=new Function("$context","with($context){with($data||{}){return "+n+";}}")}catch(e){throw new Error(e.message+' in expression "'+n+'"')}return r},this.createEvaluator=function(e,n){return d(this.createBindingExpressionEvaluator,e,n)},this.getGlobalChangeQueue=function(){return c}}).install()}));