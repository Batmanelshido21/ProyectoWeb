/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore","jquery","ojs/ojdataprovideradapter-base"],(function(e,t,n){"use strict";function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function o(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=l(e);if(t){var r=l(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return u(this,n)}}function u(e,t){return!t||"object"!==a(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var c=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(c,t);var n,a,u,l=o(c);function c(e){var t;return r(this,c),(t=l.call(this,e)).tableDataSource=e,t.FetchByKeysResults=function(){return function e(t,n,a){r(this,e),this._parent=t,this.fetchParameters=n,this.results=a,this[c._FETCHPARAMETERS]=n,this[c._RESULTS]=a}}(),t.ContainsKeysResults=function(){return function e(t,n,a){r(this,e),this._parent=t,this.containsParameters=n,this.results=a,this[c._CONTAINSPARAMETERS]=n,this[c._RESULTS]=a}}(),t.Item=function(){return function e(t,n,a){r(this,e),this._parent=t,this.metadata=n,this.data=a,this[c._METADATA]=n,this[c._DATA]=a}}(),t.FetchByOffsetResults=function(){return function e(t,n,a,i){r(this,e),this._parent=t,this.fetchParameters=n,this.results=a,this.done=i,this[c._FETCHPARAMETERS]=n,this[c._RESULTS]=a,this[c._DONE]=i}}(),t.FetchListParameters=function(){return function e(t,n,a){r(this,e),this._parent=t,this.size=n,this.sortCriteria=a,this[c._SIZE]=n,this[c._SORTCRITERIA]=a}}(),t._addTableDataSourceEventListeners(),t[c._OFFSET]=0,t._ignoreDataSourceEvents=new Array,t}return n=c,(a=[{key:"destroy",value:function(){this._removeTableDataSourceEventListeners()}},{key:"containsKeys",value:function(e){var t=this,n=[];return e[c._KEYS].forEach((function(e){n.push(t.tableDataSource.get(e))})),Promise.all(n).then((function(n){var a=new Set;return n.map((function(e){null!=e&&a.add(e[c._KEY])})),Promise.resolve(new t.ContainsKeysResults(t,e,a))}))}},{key:"fetchByKeys",value:function(e){var t=this,n=[];return e[c._KEYS].forEach((function(e){n.push(t.tableDataSource.get(e))})),Promise.all(n).then((function(n){var a=new Map;return n.map((function(e){if(null!=e){var n=e[c._KEY],r=e[c._DATA];a.set(n,new t.Item(t,new t.ItemMetadata(t,n),r))}})),Promise.resolve(new t.FetchByKeysResults(t,e,a))}))}},{key:"fetchByOffset",value:function(e){var t=this,n=null!=e?e[c._SIZE]:-1,a=null!=e?e[c._SORTCRITERIA]:null,r=null!=e&&e[c._OFFSET]>0?e[c._OFFSET]:0,i=new this.FetchListParameters(this,n,a);return this._startIndex=0,this._getFetchFunc(i,r)(i,!0).then((function(n){var a=n[c._VALUE],r=n[c._DONE],i=a[c._DATA],s=a[c._METADATA].map((function(e){return e[c._KEY]})),o=new Array;return i.map((function(e,n){o.push(new t.Item(t,new t.ItemMetadata(t,s[n]),i[n]))})),new t.FetchByOffsetResults(t,e,o,r)}))}},{key:"fetchFirst",value:function(e){return this._isPagingModelTableDataSource()||(this._startIndex=0),new this.AsyncIterable(new this.AsyncIterator(this._getFetchFunc(e),e))}},{key:"getCapability",value:function(e){return e==c._SORT&&"full"==this.tableDataSource.getCapability(e)?{attributes:"multiple"}:"fetchByKeys"==e||"fetchByOffset"==e?{implementation:"lookup"}:null}},{key:"getTotalSize",value:function(){return Promise.resolve(this.tableDataSource.totalSize())}},{key:"isEmpty",value:function(){return this.tableDataSource.totalSize()>0?"no":"yes"}},{key:"getPage",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getPage():-1}},{key:"setPage",value:function(e,t){return this._isPagingModelTableDataSource()?this.tableDataSource.setPage(e,t):Promise.reject(null)}},{key:"getStartItemIndex",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getStartItemIndex():-1}},{key:"getEndItemIndex",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getEndItemIndex():-1}},{key:"getPageCount",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getPageCount():-1}},{key:"totalSize",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.totalSize():-1}},{key:"totalSizeConfidence",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.totalSizeConfidence():null}},{key:"_getFetchFunc",value:function(e,t){var n=this;if(null!=e&&null!=e[c._SORTCRITERIA]){var a=e[c._SORTCRITERIA][0][c._ATTRIBUTE],r=e[c._SORTCRITERIA][0][c._DIRECTION];return this._ignoreSortEvent=!0,this._isPagingModelTableDataSource()||(this._startIndex=0),function(e,a){return function(r,i){if(i){var s={};return s[c._KEY]=e,s[c._DIRECTION]=a,n[c._OFFSET]=0,n.tableDataSource.sort(s).then((function(){return n._ignoreSortEvent=!1,n._getTableDataSourceFetch(r,t)(r)}))}return n._getTableDataSourceFetch(r,t)(r)}}(a,r)}return this._getTableDataSourceFetch(e,t)}},{key:"_getTableDataSourceFetch",value:function(e,t){var n=this;return function(e,a){var r={};if(t=t>0?t:0,null!=n._startIndex&&(r[c._STARTINDEX]=n._startIndex+t),r[c._PAGESIZE]=null!=e&&e[c._SIZE]>0?e[c._SIZE]:null,!n._isPagingModelTableDataSource()&&e[c._SILENT]&&(r[c._SILENT]=e[c._SILENT]),null!=n.tableDataSource[c._SORTCRITERIA]&&null==e[c._SORTCRITERIA]){e[c._SORTCRITERIA]=[];var i=new n.SortCriterion(n,n.tableDataSource[c._SORTCRITERIA][c._KEY],n.tableDataSource[c._SORTCRITERIA][c._DIRECTION]);e[c._SORTCRITERIA].push(i)}return r[c._FETCHTYPE]=e[c._FETCHTYPE],n._isFetching=!0,new Promise((function(t,a){n._fetchResolveFunc=t,n._fetchRejectFunc=a,n._fetchParams=e,n._requestEventTriggered||(n._isPagingModelTableDataSource()||r[c._SILENT]||n._ignoreDataSourceEvents.push(!0),n.tableDataSource.fetch(r).then((function(a){if(n._isPagingModelTableDataSource()||r[c._SILENT]||n._ignoreDataSourceEvents.pop(),null!==a){n._isFetching=!1,void 0===a&&((a={})[c._KEYS]=[],a[c._DATA]=[]);var i=[];null!=a[c._KEYS]&&(i=a[c._KEYS].map((function(e){return new n.ItemMetadata(n,e)}))),null==n._startIndex&&(n._startIndex=0);var s=!1;n._startIndex=n._startIndex+a[c._DATA].length,("actual"==n.tableDataSource.totalSizeConfidence()&&n.tableDataSource.totalSize()>0&&a.startIndex+a[c._DATA].length>=n.tableDataSource.totalSize()||r[c._PAGESIZE]>0&&a[c._DATA].length<r[c._PAGESIZE]||0==a[c._DATA].length)&&(s=!0),n._fetchResolveFunc=null,n._fetchParams=null,t(s?new n.AsyncIteratorReturnResult(n,new n.FetchListResult(n,e,a[c._DATA],i)):new n.AsyncIteratorYieldResult(n,new n.FetchListResult(n,e,a[c._DATA],i)))}}),(function(e){n._isPagingModelTableDataSource()||r[c._SILENT]||n._ignoreDataSourceEvents.pop(),a(e)})))}))}}},{key:"_handleSync",value:function(t){var n=this;if(!(n._ignoreDataSourceEvents.length>0)){if(n._startIndex=null,t[c._STARTINDEX]>0&&(n._startIndex=t[c._STARTINDEX],n[c._OFFSET]=n._startIndex),n._fetchResolveFunc&&null!=t[c._KEYS]){n._isFetching=!1;var a=t[c._KEYS].map((function(e){return new n.ItemMetadata(n,e)})),r=!1;"actual"==n.tableDataSource.totalSizeConfidence()&&n.tableDataSource.totalSize()>0&&n._startIndex+t[c._DATA].length>=n.tableDataSource.totalSize()&&(r=!0),r?n._fetchResolveFunc(new n.AsyncIteratorReturnResult(n,new n.FetchListResult(n,n._fetchParams,t[c._DATA],a))):n._fetchResolveFunc(new n.AsyncIteratorYieldResult(n,new n.FetchListResult(n,n._fetchParams,t[c._DATA],a))),n._fetchResolveFunc=null,n._fetchParams=null}else n._requestEventTriggered||n.dispatchEvent(new e.DataProviderRefreshEvent);n._requestEventTriggered=!1}}},{key:"_handleAdd",value:function(t){var n=this,a=t[c._KEYS].map((function(e){return new n.ItemMetadata(n,e)})),r=new Set;t[c._KEYS].map((function(e){r.add(e)}));var i=new n.DataProviderAddOperationEventDetail(n,r,null,null,null,a,t[c._DATA],t[c._INDEXES]),s=new n.DataProviderMutationEventDetail(n,i,null,null);n.dispatchEvent(new e.DataProviderMutationEvent(s))}},{key:"_handleRemove",value:function(t){var n=this,a=t[c._KEYS].map((function(e){return new n.ItemMetadata(n,e)})),r=new Set;t[c._KEYS].map((function(e){r.add(e)}));var i=new n.DataProviderOperationEventDetail(n,r,a,t[c._DATA],t[c._INDEXES]),s=new n.DataProviderMutationEventDetail(n,null,i,null);n.dispatchEvent(new e.DataProviderMutationEvent(s))}},{key:"_handleReset",value:function(t){this._requestEventTriggered||this._isPagingModelTableDataSource()||(this._startIndex=0,this.dispatchEvent(new e.DataProviderRefreshEvent))}},{key:"_handleSort",value:function(t){this._ignoreSortEvent||(this._startIndex=null,this.dispatchEvent(new e.DataProviderRefreshEvent))}},{key:"_handleChange",value:function(t){var n=this,a=t[c._KEYS].map((function(e){return new n.ItemMetadata(n,e)})),r=new Set;t[c._KEYS].map((function(e){r.add(e)}));var i=new n.DataProviderOperationEventDetail(n,r,a,t[c._DATA],t[c._INDEXES]),s=new n.DataProviderMutationEventDetail(n,null,null,i);n.dispatchEvent(new e.DataProviderMutationEvent(s))}},{key:"_handleRefresh",value:function(t){this._isFetching||this._requestEventTriggered||(null!=t[c._OFFSET]?this._startIndex=t[c._OFFSET]:this._startIndex=null,this.dispatchEvent(new e.DataProviderRefreshEvent)),this._requestEventTriggered=!1}},{key:"_handleRequest",value:function(t){this._ignoreDataSourceEvents.length>0||void 0!==e.Model&&t instanceof e.Model||this._isFetching||(t[c._STARTINDEX]>0&&0==this.getStartItemIndex()&&(this._startIndex=t[c._STARTINDEX]),this._requestEventTriggered=!0,this.dispatchEvent(new e.DataProviderRefreshEvent))}},{key:"_handleError",value:function(e){this._fetchRejectFunc&&this._fetchRejectFunc(e),this._isFetching=!1,this._requestEventTriggered=!1}},{key:"_handlePage",value:function(t){this._isFetching=!1,this._requestEventTriggered=!1;var n={};n.detail=t,this.dispatchEvent(new e.GenericEvent(e.PagingModel.EventType.PAGE,n))}},{key:"_addTableDataSourceEventListeners",value:function(){this.removeAllListeners(),this.addListener("sync",this._handleSync),this.addListener("add",this._handleAdd),this.addListener("remove",this._handleRemove),this.addListener("reset",this._handleReset),this.addListener("sort",this._handleSort),this.addListener("change",this._handleChange),this.addListener("refresh",this._handleRefresh),this.addListener("request",this._handleRequest),this.addListener("error",this._handleError),this.addListener("page",this._handlePage)}},{key:"_removeTableDataSourceEventListeners",value:function(){this.removeListener("sync"),this.removeListener("add"),this.removeListener("remove"),this.removeListener("reset"),this.removeListener("sort"),this.removeListener("change"),this.removeListener("refresh"),this.removeListener("request"),this.removeListener("error"),this.removeListener("page")}},{key:"_isPagingModelTableDataSource",value:function(){return null!=this.tableDataSource.getStartItemIndex}}])&&i(n.prototype,a),u&&i(n,u),c}(n);c._STARTINDEX="startIndex",c._SILENT="silent",c._SORTCRITERIA="sortCriteria",c._PAGESIZE="pageSize",c._OFFSET="offset",c._SIZE="size",c._CONTAINSPARAMETERS="containsParameters",c._RESULTS="results",c._FETCHTYPE="fetchType",e.EventTargetMixin.applyMixin(c),e.TableDataSourceAdapter=c,e.TableDataSourceAdapter=c}));