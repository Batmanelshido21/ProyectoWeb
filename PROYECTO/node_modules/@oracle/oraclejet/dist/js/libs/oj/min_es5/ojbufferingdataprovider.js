/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore","ojs/ojset","ojs/ojmap","ojs/ojdataprovider","ojs/ojcomponentcore","ojs/ojeventtarget"],(function(t,e,a,i){"use strict";var r=t.GenericEvent;function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function o(t,e,a){return e&&s(t.prototype,e),a&&s(t,a),t}var u=function(){function r(t,a){n(this,r),this.dataProvider=t,this.options=a,this.AsyncIterable=function(){return function t(e,a){n(this,t),this._parent=e,this._asyncIterator=a,this[Symbol.asyncIterator]=function(){return this._asyncIterator}}}(),this.AsyncIterator=function(){function t(a,i,r){n(this,t),this._parent=a,this._baseIterator=i,this._params=r,this.itemArray=[],this.firstBaseKey=null,this.mergedAddKeySet=new e,this.mergedMetadataArray=[],this.mergedDataArray=[]}return o(t,[{key:"_fetchNext",value:function(){var t=this;return this._baseIterator.next().then((function(e){if(!t.firstBaseKey&&e.value.metadata.length&&(t.firstBaseKey=e.value.metadata[0].key),!t._parent.editBuffer.isEmpty()){var a=e.value.data.map((function(t,a){return{data:e.value.data[a],metadata:e.value.metadata[a]}})),i=t.itemArray.slice();t.itemArray=[],t._parent._mergeEdits(a,i,t._params.filterCriterion,t._params.sortCriteria,!0,t.mergedAddKeySet,e.done);var r=t._params||{};if((r.size&&i.length<r.size||null==r.size&&0===i.length)&&!e.done)return t.itemArray=i,t._fetchNext();r.size&&i.length>r.size&&(t.itemArray=i.splice(r.size));var n=e.done&&0===t.itemArray.length,s=i.map((function(t){return t.data})),o=i.map((function(t){return t.metadata}));return{done:n,value:{fetchParameters:t._params,data:s,metadata:o}}}return e}))}},{key:"next",value:function(){var t=this;return this._fetchNext().then((function(e){for(var a=e.value.metadata,i=e.value.data,r=0;r<a.length;r++)t.mergedMetadataArray.push(a[r]),t.mergedDataArray.push(i[r]);return e}))}}]),t}(),this._addEventListeners(t),this.editBuffer=new v,this.lastSubmittableCount=0,this.lastFetchListParams=null,this.lastIterator=null}return o(r,[{key:"_fetchByKeysFromBuffer",value:function(t){var i=this,r=new a,n=new e;return t.keys.forEach((function(t){var e=i.editBuffer.getItem(t);if(e)switch(e.operation){case"add":case"update":r.set(t,e.item)}else n.add(t)})),{results:r,unresolvedKeys:n}}},{key:"_compareItem",value:function(t,e,a){for(var i=0;i<a.length;i++){if(t[a[i].attribute]>e[a[i].attribute])return"ascending"===a[i].direction?1:-1;if(t[a[i].attribute]<e[a[i].attribute])return"ascending"===a[i].direction?-1:1}return 0}},{key:"_insertAddEdits",value:function(t,e,a,i,r,n){var s=this;t.forEach((function(t,o){if("add"===t.operation&&!r.has(o)&&(!e||e.filter(t.item.data)))if(a&&a.length){for(var u=!1,d=0;d<i.length;d++)if(s._compareItem(t.item.data,i[d].data,a)<0){i.splice(d,0,t.item),r.add(o),u=!0;break}!u&&n&&(i.push(t.item),r.add(o))}else i.push(t.item),r.add(o)}))}},{key:"_mergeAddEdits",value:function(t,e,a,i,r){this._insertAddEdits(this.editBuffer.getUnsubmittedItems(),t,e,a,i,r),this._insertAddEdits(this.editBuffer.getSubmittingItems(),t,e,a,i,r)}},{key:"_mergeEdits",value:function(t,e,a,r,n,s,o){var u;a&&(u=a.filter?a:i.FilterFactory.getFilter({filterDef:a,filterOptions:this.options})),!n||r&&r.length||this._mergeAddEdits(u,r,e,s,o);for(var d=0;d<t.length;d++){var f=t[d],m=this.editBuffer.getItem(f.metadata.key);m?"remove"===m.operation||"update"===m.operation&&(u&&!u.filter(m.item.data)||e.push(m.item)):e.push(f)}r&&r.length&&this._mergeAddEdits(u,r,e,s,o)}},{key:"_fetchFromOffset",value:function(t,a){var i=this;return this.dataProvider.fetchByOffset(t).then((function(r){if(!i.editBuffer.isEmpty()){var n=r.results;if(i._mergeEdits(n,a,t.filterCriterion,t.sortCriteria,0===t.offset,new e,r.done),(t.size&&a.length<t.size||null==t.size&&0===a.length)&&!r.done){var s={attributes:t.attributes,clientId:t.clientId,filterCriterion:t.filterCriterion,offset:t.offset+r.results.length,size:t.size,sortCriteria:t.sortCriteria};return i._fetchFromOffset(s,a)}return t.size&&a.length>t.size&&a.splice(t.size),{fetchParameters:t,results:a,done:r.done}}return r}))}},{key:"containsKeys",value:function(t){var a=this._fetchByKeysFromBuffer(t),i=a.unresolvedKeys,r=new e;return a.results.forEach((function(t,e){r.add(e)})),0===i.size?Promise.resolve({containsParameters:t,results:r}):this.dataProvider.containsKeys({attributes:t.attributes,keys:i,scope:t.scope}).then((function(e){return r.size>0?(e.results.forEach((function(t,e){r.add(e)})),{containsParameters:t,results:r}):e}))}},{key:"fetchByKeys",value:function(t){var e=this._fetchByKeysFromBuffer(t),a=e.unresolvedKeys,i=e.results;return 0===a.size?Promise.resolve({fetchParameters:t,results:i}):this.dataProvider.fetchByKeys({attributes:t.attributes,keys:a,scope:t.scope}).then((function(e){return i.size>0?(e.results.forEach((function(t,e){i.set(e,t)})),{fetchParameters:t,results:i}):e}))}},{key:"fetchByOffset",value:function(t){return this._fetchFromOffset(t,[])}},{key:"fetchFirst",value:function(t){this.lastFetchListParams=t;var e=this.dataProvider.fetchFirst(t)[Symbol.asyncIterator]();return this.lastIterator=new this.AsyncIterator(this,e,t),new this.AsyncIterable(this,this.lastIterator)}},{key:"getCapability",value:function(t){return this.dataProvider.getCapability(t)}},{key:"_calculateSizeChange",value:function(t){var e=0;return t.forEach((function(t,a){"add"===t.operation?++e:"remove"===t.operation&&--e})),e}},{key:"getTotalSize",value:function(){var t=this;return this.dataProvider.getTotalSize().then((function(e){return e>-1&&(e+=t._calculateSizeChange(t.editBuffer.getSubmittingItems()),e+=t._calculateSizeChange(t.editBuffer.getUnsubmittedItems())),e}))}},{key:"isEmpty",value:function(){var t=this.editBuffer.getUnsubmittedItems(),e=this.editBuffer.getSubmittingItems();t.forEach((function(t,e){if("add"===t.operation||"update"===t.operation)return"no"})),e.forEach((function(t,e){if("add"===t.operation||"update"===t.operation)return"no"}));var a=this.dataProvider.isEmpty();return"no"===a&&(t.size>0||e.size>0)?"unknown":a}},{key:"_addToMergedArrays",value:function(t){var e=null;if(this.lastIterator){var a=this.lastFetchListParams?this.lastFetchListParams.sortCriteria:null;if(a&&a.length){for(var i=this.lastIterator.mergedMetadataArray,r=this.lastIterator.mergedDataArray,n=0;n<r.length;n++)if(this._compareItem(t.data,r[n],a)<0){e=i[n].key,i.splice(n,0,t.metadata),r.splice(n,0,t.data);break}}else e=this.lastIterator.firstBaseKey}return e}},{key:"addItem",value:function(t){this.editBuffer.addItem(t);var a=this._addToMergedArrays(t),r={add:{data:[t.data],keys:(new e).add(t.metadata.key),metadata:[t.metadata],addBeforeKeys:[a]}},n=new i.DataProviderMutationEvent(r);this.dispatchEvent(n),this._dispatchSubmittableChangeEvent()}},{key:"_removeFromMergedArrays",value:function(e){if(this.lastIterator){var a=this.lastIterator.mergedMetadataArray,i=this.lastIterator.mergedDataArray,r=this.lastIterator.mergedAddKeySet,n=this._findKeyInMetadata(e,a);-1!==n&&(a.splice(n,1),i.splice(n,1),r.delete(e),t.KeyUtils.equals(this.lastIterator.firstBaseKey,e)&&(a.length>n?this.lastIterator.firstBaseKey=a[n].key:this.lastIterator.firstBaseKey=null))}}},{key:"removeItem",value:function(t){this.editBuffer.removeItem(t),this._removeFromMergedArrays(t.metadata.key);var a={remove:{data:t.data?[t.data]:null,keys:(new e).add(t.metadata.key),metadata:[t.metadata]}},r=new i.DataProviderMutationEvent(a);this.dispatchEvent(r),this._dispatchSubmittableChangeEvent()}},{key:"updateItem",value:function(t){this.editBuffer.updateItem(t);var a={update:{data:[t.data],keys:(new e).add(t.metadata.key),metadata:[t.metadata]}},r=new i.DataProviderMutationEvent(a);this.dispatchEvent(r),this._dispatchSubmittableChangeEvent()}},{key:"getSubmittableItems",value:function(){var t=this.editBuffer.getUnsubmittedItems(),e=this.editBuffer.getSubmittingItems(),a=[];return t.forEach((function(t,i){e.has(i)||a.push(t)})),a}},{key:"resetAllUnsubmittedItems",value:function(){this.editBuffer.getUnsubmittedItems().clear(),this._dispatchSubmittableChangeEvent(),this.dispatchEvent(new i.DataProviderRefreshEvent)}},{key:"_addEventDetail",value:function(t,a,i){null==t[a]&&(t[a]={data:[],keys:new e,metadata:[]}),t[a].keys.add(i.metadata.key),t[a].data.push(i.data),t[a].metadata.push(i.metadata)}},{key:"resetUnsubmittedItem",value:function(t){var r=this,n=this.editBuffer.getUnsubmittedItems(),s=new e,o=new a,u=n.get(t);u&&(s.add(t),o.set(t,u),n.delete(t)),this._dispatchSubmittableChangeEvent(),this.dataProvider.fetchByKeys({keys:s}).then((function(t){var e,a={};o.forEach((function(i,n){"add"===i.operation?r._addEventDetail(a,"remove",i.item):"remove"===i.operation?(e=t.results.get(n))&&r._addEventDetail(a,"add",e):(e=t.results.get(n))?r._addEventDetail(a,"update",e):r._addEventDetail(a,"remove",i.item)})),r.dispatchEvent(new i.DataProviderMutationEvent(a))}))}},{key:"setItemStatus",value:function(t,e,a){t&&(this.editBuffer.setItemStatus(t,e,a),this._dispatchSubmittableChangeEvent())}},{key:"_dispatchSubmittableChangeEvent",value:function(){var t=this.getSubmittableItems();if(t.length!==this.lastSubmittableCount){this.lastSubmittableCount=t.length;var e=new c(t);this.dispatchEvent(e)}}},{key:"_findKeyInMetadata",value:function(e,a){if(a)for(var i=0;i<a.length;i++)if(t.KeyUtils.equals(e,a[i].key))return i;return-1}},{key:"_initDetailProp",value:function(t,e,a,i){t[a]&&(e[a]=i)}},{key:"_pushDetailProp",value:function(t,e,a,i){t[a]&&e[a].push(t[a][i])}},{key:"_getOperationDetail",value:function(t,a){var i=this;if(t){var r={},n=this.editBuffer.getSubmittingItems(),s=this.editBuffer.getUnsubmittedItems();if(0!==n.size||0!==s.size)return r.keys=new e,this._initDetailProp(t,r,"data",[]),this._initDetailProp(t,r,"metadata",[]),this._initDetailProp(t,r,"addBeforeKeys",[]),this._initDetailProp(t,r,"parentKeys",[]),t.keys.forEach((function(e){var o=null!=n.get(e);if(!o){var u=s.get(e);o=u&&"remove"===u.operation}if(!o&&(r.keys.add(e),t.metadata)){var d=i._findKeyInMetadata(e,t.metadata);d>-1&&(i._pushDetailProp(t,r,"data",d),i._pushDetailProp(t,r,"metadata",d),i._pushDetailProp(t,r,"addBeforeKeys",d),i._pushDetailProp(t,r,"parentKeys",d))}if(a){var f=s.get(e);!f||"remove"!==f.operation&&"update"!==f.operation||s.delete(e)}})),r;this._initDetailProp(t,r,"data",t.data),this._initDetailProp(t,r,"metadata",t.metadata),this._initDetailProp(t,r,"addBeforeKeys",t.addBeforeKeys),this._initDetailProp(t,r,"parentKeys",t.parentKeys)}return t}},{key:"_handleRefreshEvent",value:function(t){var a=this,i=this.editBuffer.getUnsubmittedItems(),r=new e;i.forEach((function(t){"remove"!==t.operation&&"update"!==t.operation||r.add(t.item.metadata.key)})),r.size>0?this.dataProvider.fetchByKeys({keys:r}).then((function(e){e.results.forEach((function(t,e){r.delete(e)})),r.forEach((function(t){i.delete(t)})),a.dispatchEvent(t)})):this.dispatchEvent(t)}},{key:"_handleMutateEvent",value:function(t){var e=this;t.detail.remove&&t.detail.remove.keys.forEach((function(t){e._removeFromMergedArrays(t)}));var a=t.detail.add;a&&a.metadata&&a.data&&a.metadata.forEach((function(t,i){e._addToMergedArrays({metadata:a.metadata[i],data:a.data[i]})}));var r={add:this._getOperationDetail(t.detail.add,!1),remove:this._getOperationDetail(t.detail.remove,!0),update:this._getOperationDetail(t.detail.update,!1)};this.dispatchEvent(new i.DataProviderMutationEvent(r))}},{key:"_addEventListeners",value:function(t){t[r._ADDEVENTLISTENER](r._REFRESH,this._handleRefreshEvent.bind(this)),t[r._ADDEVENTLISTENER](r._MUTATE,this._handleMutateEvent.bind(this))}}]),r}();function d(t){return(d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function f(t,e){return(f=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function m(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var a,i=l(t);if(e){var r=l(this).constructor;a=Reflect.construct(i,arguments,r)}else a=i.apply(this,arguments);return h(this,a)}}function h(t,e){return!e||"object"!==d(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function l(t){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}u._REFRESH="refresh",u._MUTATE="mutate",u._ADDEVENTLISTENER="addEventListener",t.BufferingDataProvider=u,t.EventTargetMixin.applyMixin(u);var c=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&f(t,e)}(a,t);var e=m(a);function a(t){n(this,a);var i={};return i.detail=t,e.call(this,"submittableChange",i)}return a}(r);
/**
 * @preserve Copyright 2013 jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function o(t,e,a){return e&&s(t.prototype,e),a&&s(t,a),t}var v=function(){function e(){n(this,e),this.unsubmittedItems=new a,this.submittingItems=new a}return o(e,[{key:"addItem",value:function(e){var a=this.unsubmittedItems.get(e.metadata.key),i=this.submittingItems.get(e.metadata.key);if(a&&("add"===a.operation||"update"===a.operation)||i&&("add"===i.operation||"update"===i.operation))throw new Error("Cannot add item with same key as an item being added or updated");a&&"remove"===a.operation?a.item.data&&t.Object.compareValues(a.item.data,e.data)?this.unsubmittedItems.delete(e.metadata.key):this.unsubmittedItems.set(e.metadata.key,{operation:"update",item:e}):this.unsubmittedItems.set(e.metadata.key,{operation:"add",item:e})}},{key:"removeItem",value:function(t){var e=this.unsubmittedItems.get(t.metadata.key),a=this.submittingItems.get(t.metadata.key);if(e&&"remove"===e.operation||a&&"remove"===a.operation)throw new Error("Cannot remove item with same key as an item being removed");e&&"add"===e.operation?this.unsubmittedItems.delete(t.metadata.key):(e&&e.operation,this.unsubmittedItems.set(t.metadata.key,{operation:"remove",item:t}))}},{key:"updateItem",value:function(t){var e=this.unsubmittedItems.get(t.metadata.key),a=this.submittingItems.get(t.metadata.key);if(e&&"remove"===e.operation||a&&"remove"===a.operation)throw new Error("Cannot update item with same key as an item being removed");!e||"add"!==e.operation&&"update"!==e.operation?this.unsubmittedItems.set(t.metadata.key,{operation:"update",item:t}):this.unsubmittedItems.set(t.metadata.key,{operation:e.operation,item:t})}},{key:"setItemStatus",value:function(t,e,a){var i=t.item.metadata.key;if("submitting"===e)this.unsubmittedItems.delete(i),this.submittingItems.set(i,t);else if("submitted"===e)this.submittingItems.delete(i);else if("unsubmitted"===e){var r;this.submittingItems.delete(i),r=a?{operation:t.operation,item:{data:t.item.data,metadata:{key:t.item.metadata.key,message:a}}}:t,this.unsubmittedItems.set(i,r)}}},{key:"getUnsubmittedItems",value:function(){return this.unsubmittedItems}},{key:"getSubmittingItems",value:function(){return this.submittingItems}},{key:"isEmpty",value:function(){return 0===this.unsubmittedItems.size&&0===this.submittingItems.size}},{key:"getItem",value:function(t){var e=this.unsubmittedItems.get(t);return e||(e=this.submittingItems.get(t)),e}}]),e}();
/**
 * @preserve Copyright 2013 jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */return u}));