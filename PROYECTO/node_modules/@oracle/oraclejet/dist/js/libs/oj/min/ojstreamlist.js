define(["exports","ojs/ojvcomponent","ojs/ojdatacollection-common","ojs/ojcontext","ojs/ojvcollection","ojs/ojcore-base","ojs/ojkeyset","ojs/ojtreedataprovider","ojs/ojanimation"],(function(e,t,s,n,o,r,l,i,a){"use strict";
/**
     * @license
     * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
     * The Universal Permissive License (UPL), Version 1.0
     * as shown at https://oss.oracle.com/licenses/upl/
     * @ignore
     */class h extends o.IteratingDataProviderContentHandler{constructor(e,t,s,o){super(e,t,s,o),this.root=e,this.dataProvider=t,this.callback=s,this.scrollPolicyOptions=o,this.postRender=()=>{this.vnodesCache=this.newVnodesCache,this.newVnodesCache=new Map;const e=this.root.lastElementChild;if(e){n.getContext(e).getBusyContext().whenReady().then(()=>{if(this.callback){if(this.domScroller){let t=e.querySelectorAll(".oj-stream-list-item");const s=this.root.offsetTop,n=t[0].offsetTop-s,o=t[t.length-1].offsetTop+t[t.length-1].offsetHeight-s;this.domScroller.setViewportRange(n,o)}if(this.domScroller&&!this.domScroller.checkViewport())return}})}},this.newItemsTracker=new Set,this.vnodesCache=new Map,this.newVnodesCache=new Map}handleFetchSuccess(e){null!=e&&this.newItemsTracker.clear(),super.handleFetchSuccess(e)}handleItemsUpdated(e){e.keys.forEach(function(e){this.vnodesCache.delete(e)}.bind(this)),super.handleItemsUpdated(e)}handleItemsRemoved(e){e.keys.forEach(function(e){this.vnodesCache.delete(e)}.bind(this)),super.handleItemsRemoved(e)}handleModelRefresh(){this.vnodesCache.clear(),super.handleModelRefresh()}addItem(e,t,s,n){const o=this.isInitialFetch();null==this.callback.getCurrentItem()&&o&&0==t&&this.callback.setCurrentItem(e);const r=this.renderItem(e,t,s);return this.decorateItem(r,e,t,o,n),r}renderItem(e,t,s){const n=this.vnodesCache.get(e);if(n)return this.newVnodesCache.set(e,{vnodes:n.vnodes}),n.vnodes;const o=this.callback.getItemRenderer()({data:s,key:e});let r;for(let e=0;e<o.length;e++){if(1===o[e]._node.nodeType){r=o[e];break}}let l=[r];return this.newVnodesCache.set(e,{vnodes:l}),l}decorateItem(e,t,s,n,o){let r=e[0],l=r._node;if(null!=l){r.key=t,l.key=t,l.setAttribute("key",JSON.stringify(t)),l.setAttribute("role","listitem"),l.setAttribute("tabIndex","-1");this.getItemStyleClass(o,this.newItemsTracker.has(t),n).forEach(e=>{l.classList.add(e)});const e=this.getItemInlineStyle(o,s,n);Object.keys(e).forEach(t=>{l.style[t]=e[t]})}}getItemInlineStyle(e,t,s){return{}}getItemStyleClass(e,t,s){let n=[];return n.push("oj-stream-list-item"),n}renderSkeletonsForLoadMore(){return this.callback.renderSkeletons(3)}}class d extends o.IteratingTreeDataProviderContentHandler{constructor(e,t,s,o){super(e,t,s,o),this.root=e,this.dataProvider=t,this.callback=s,this.scrollPolicyOptions=o,this.postRender=()=>{this.vnodesCache=this.newVnodesCache,this.newVnodesCache=new Map;const e=this.root.lastElementChild;if(e){n.getContext(e).getBusyContext().whenReady().then(()=>{this.checkViewport()})}},this.getLoadMoreCount=()=>3,this.newItemsTracker=new Set,this.vnodesCache=new Map,this.newVnodesCache=new Map}handleFetchSuccess(e){null!=e&&this.newItemsTracker.clear(),super.handleFetchSuccess(e)}handleItemsUpdated(e){e.keys.forEach(function(e){this.vnodesCache.delete(e)}.bind(this)),super.handleItemsUpdated(e)}handleItemsRemoved(e){e.keys.forEach(function(e){this.vnodesCache.delete(e)}.bind(this)),super.handleItemsRemoved(e)}handleModelRefresh(){this.vnodesCache.clear(),super.handleModelRefresh()}addItem(e,t,s,n){const o=this.isInitialFetch();null==this.callback.getCurrentItem()&&o&&0==t&&this.callback.setCurrentItem(e.key);const r=this.renderItem(e,t,s);return this.decorateItem(r,e,t,o,n),r}renderItem(e,t,s){let n=e.key;const o=this.vnodesCache.get(n);if(o)return this.newVnodesCache.set(n,{vnodes:o.vnodes}),o.vnodes;let r,l,i;e.isLeaf||(r=this.callback.getGroupRenderer()),null==r&&(r=this.callback.getItemRenderer()),l=r({data:s,key:e.key,leaf:e.isLeaf,parentKey:e.parentKey,depth:e.treeDepth});for(let e=0;e<l.length;e++){if(1===l[e]._node.nodeType){i=l[e];break}}let a=[i];return this.newVnodesCache.set(n,{vnodes:a}),a}decorateItem(e,t,s,n,o){let r=e[0],l=r._node;if(null!=l){r.key=t.key,l.key=t.key,l.setAttribute("key",JSON.stringify(t.key)),l.setAttribute("role","listitem"),l.setAttribute("tabIndex","-1");this.getItemStyleClass(t,o,this.newItemsTracker.has(t.key),n).forEach(e=>{l.classList.add(e)});const e=this.getItemInlineStyle(t,o,s,n);if(Object.keys(e).forEach(t=>{l.style[t]=e[t]}),!t.isLeaf){let e=this.callback.getExpanded();e&&e.has(t.key)?l.setAttribute("aria-expanded","true"):l.setAttribute("aria-expanded","false")}}}getItemInlineStyle(e,t,s,n){return{}}getItemStyleClass(e,t,s,n){let o=[];return e.isLeaf?o.push("oj-stream-list-item"):o.push("oj-stream-list-group"),o}renderSkeletonsForLoadMore(){return this.callback.renderSkeletons(3)}renderSkeletonsForExpand(e){return this.callback.renderSkeletons(this.getLoadMoreCount(),!0,e)}}var c,u=function(e,t,s,n){var o,r=arguments.length,l=r<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,s):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,s,n);else for(var i=e.length-1;i>=0;i--)(o=e[i])&&(l=(r<3?o(l):r>3?o(t,s,l):o(t,s))||l);return r>3&&l&&Object.defineProperty(t,s,l),l};e.StreamList=c=class extends t.VComponent{constructor(e){super(e),this.restoreFocus=!1,this.actionableMode=!1,this.skeletonHeight=0,this.height=0,this.setRootElement=e=>{this.root=e},this.state={renderedData:null,outOfRangeData:null,initialSkeleton:!0,initialSkeletonCount:1,expandedToggleKeys:new l.KeySetImpl,expandedSkeletonKeys:new l.KeySetImpl,expandingKeys:new l.KeySetImpl,toCollapse:[]}}_handleFocusIn(e){this._clearFocusoutTimeout();let t=e.target,s=t.closest(".oj-stream-list-item, .oj-stream-list-group");s&&this._isFocusable(t,s)&&this._enterActionableMode(t)}_handleFocusOut(){this._clearFocusoutTimeout(),this.actionableMode?this._focusoutTimeout=setTimeout(function(){this._doBlur()}.bind(this),100):this._isFocusBlurTriggeredByDescendent(event)||this._doBlur()}_clearFocusoutTimeout(){this._focusoutTimeout&&(clearTimeout(this._focusoutTimeout),this._focusoutTimeout=null)}_handleClick(e){let t=e.target.closest("."+this.getGroupStyleClass());if(t){let e=t.key,s=this.props.expanded.has(e);this._handleToggleExpanded(e,s)}this._handleTouchOrClickEvent(e)}_handleToggleExpanded(e,t){this.updateState(function(s,n){let o=s.expandedToggleKeys;if(!o.has(e)){o=o.add([e]);let s=n.expanded;return o.values().forEach(e=>{s=t?s.delete([e]):s.add([e])}),this._updateProperty("expanded",s,!0),{expandedToggleKeys:o}}return{}}.bind(this))}_handleKeyDown(e){if(this.currentItem){let t;switch(e.keyCode){case 37:case 39:if(this.currentItem.classList.contains(this.getGroupStyleClass())){let t=this.currentItem.key,s=this.props.expanded.has(t);(39===e.keyCode&&!s||37===e.keyCode&&s)&&this._handleToggleExpanded(t,s)}break;case 38:if(!1===this.actionableMode)for(t=this.currentItem.previousElementSibling;t&&t.previousElementSibling&&t.classList.contains("oj-stream-list-skeleton");)t=t.previousElementSibling;break;case 40:if(!1===this.actionableMode)for(t=this.currentItem.nextElementSibling;t&&t.nextElementSibling&&t.classList.contains("oj-stream-list-skeleton");)t=t.nextElementSibling;break;case 113:!1===this.actionableMode&&this._enterActionableMode();break;case 27:!0===this.actionableMode&&this._exitActionableMode(!0);break;case 9:!0===this.actionableMode&&this.currentItem&&(e.shiftKey?s.handleActionablePrevTab(e,this.currentItem)&&e.preventDefault():s.handleActionableTab(e,this.currentItem)&&e.preventDefault())}null!=t&&(t.classList.contains(this.getItemStyleClass())||t.classList.contains(this.getGroupStyleClass()))&&(this._updateCurrentItemAndFocus(t,!0),e.preventDefault())}}_touchStartHandler(e){this._handleTouchOrClickEvent(e)}render(){const e=this.state.initialSkeleton,s=this.state.initialSkeletonCount;let n;if(null==this.contentHandler&&e)n=this._renderInitialSkeletons(s);else{const t=this.getData();null!=t&&e||null==t?n=this._renderInitialSkeletons(s,null==t):null!=t&&(n=this.contentHandler.render(),this.currentItem&&this.currentItem.contains(document.activeElement)&&(this.restoreFocus=!0))}return t.h("oj-stream-list",{ref:this.setRootElement},t.h("div",{role:"list","data-oj-context":!0,onClick:this._handleClick,onKeydown:this._handleKeyDown,onTouchstart:this._touchStartHandler,onFocusin:this._handleFocusIn,onFocusout:this._handleFocusOut},n))}_doBlur(){this.actionableMode&&this._exitActionableMode(!1),this.currentItem&&this.currentItem.classList.remove("oj-focus")}_isFocusBlurTriggeredByDescendent(e){return void 0===e.relatedTarget||!(null==e.relatedTarget||!this.root.contains(e.relatedTarget))}_renderInitialSkeletons(e,t){if(t){const e=this._getScroller();null!=e&&(e.scrollTop=0)}return this.renderSkeletons(e)}renderSkeletons(e,t,s){let n,o=[],r=this._isTreeData();for(let l=0;l<e;l++){let e=t;!t&&r&&l%4&&(e=!0),s&&(n=s+"_"+l),o.push(this._renderSkeleton(e,n))}return o}_renderSkeleton(e,s){let n="oj-stream-list-skeleton";return e&&(n+=" oj-stream-list-child-skeleton"),t.h("div",{class:n,key:s},t.h("div",{class:"oj-stream-list-skeleton-content oj-animation-skeleton"}))}_applySkeletonExitAnimation(e){return new Promise((t,s)=>{let n=[];e.forEach(e=>{n.push(a.fadeOut(e))}),Promise.all(n).then((function(){t(!0)}))})}_isTreeData(){var e=this.props.data;return null!=e&&this.instanceOfTreeDataProvider(e)}instanceOfTreeDataProvider(e){return"getChildDataProvider"in e}_postRender(){this._registerScrollHandler();const e=this.getData();let t=this.state.initialSkeleton;if(null!=e&&t){let e=this.getRootElement().querySelectorAll(".oj-stream-list-skeleton");this._applySkeletonExitAnimation(e).then(function(){this.updateState({initialSkeleton:!1})}.bind(this))}else null!=e&&this.contentHandler.postRender();this.actionableMode=!1;let s=this.root.querySelectorAll(".oj-stream-list-item, .oj-stream-list-group");this._disableAllTabbableElements(s),this._restoreCurrentItem(s)}mounted(){var e=this.props.data;this._isTreeData()?this.contentHandler=new d(this.root,e,this,this.props.scrollPolicyOptions):null!=e&&(this.contentHandler=new h(this.root,e,this,this.props.scrollPolicyOptions)),this.contentHandler.fetchRows(),this.height=this.root.clientHeight;let t=this.root.querySelector(".oj-stream-list-skeleton");if(t&&(this.skeletonHeight=this.outerHeight(t),this.updateState({initialSkeletonCount:Math.max(1,Math.floor(this.height/this.skeletonHeight))})),window.ResizeObserver){let e=this.root;const t=new window.ResizeObserver(t=>{t.forEach(t=>{if(t.target===e&&t.contentRect){const e=this.height,s=Math.round(t.contentRect.height);Math.abs(s-e)>1&&(this.height=s,this.contentHandler&&this.contentHandler.domScroller&&this.contentHandler.domScroller.checkViewport())}})});t.observe(e),this.resizeObserver=t}this._postRender()}getSkeletonHeight(){return this.skeletonHeight}outerHeight(e){let t=e.offsetHeight,s=getComputedStyle(e);return t+=parseInt(s.marginTop)+parseInt(s.marginBottom),t}unmounted(){this.contentHandler&&this.contentHandler.destroy(),this.contentHandler=null,this.resizeObserver&&this.resizeObserver.disconnect(),this.resizeObserver=null,this.scrollListener&&null!=this._getScroller()&&this._getScroller().removeEventListener("scroll",this.scrollListener)}getRootElement(){return this.root}updated(e,t){this._isTreeData()&&this.contentHandler.collapse&&this.contentHandler.collapse(this.state.toCollapse);let s=t.expandingKeys;this.state.expandingKeys.values().forEach(function(e){s.has(e)||this.contentHandler.expand(e)}.bind(this)),this.props.data!=e.data&&(this.contentHandler&&this.contentHandler.destroy(),this.setCurrentItem(null),this.updateState({renderedData:null,outOfRangeData:null,initialSkeleton:!0,initialSkeletonCount:this.state.initialSkeletonCount,expandedToggleKeys:new l.KeySetImpl,expandedSkeletonKeys:new l.KeySetImpl,expandingKeys:new l.KeySetImpl}),this._isTreeData()?this.contentHandler=new d(this.root,this.props.data,this,this.props.scrollPolicyOptions):null!=this.props.data&&(this.contentHandler=new h(this.root,this.props.data,this,this.props.scrollPolicyOptions)),this.contentHandler.fetchRows()),this._postRender(),this.props.scrollPosition!=e.scrollPosition&&this._syncScrollTopWithProps()}static initStateFromProps(e,t){return c.updateStateFromProps(e,t,null)}static updateStateFromProps(e,t,s){let{expandedToggleKeys:n,expandingKeys:o,renderedData:r,expandedSkeletonKeys:l}=t,i=[],a=e.expanded;if(s&&a!==s.expanded){let e=s.expanded;return n.values().forEach(t=>{e.has(t)!==a.has(t)&&(n=n.delete([t]))}),r.value.metadata.forEach(e=>{let t=e.key,s=e.expanded,n=a.has(t);s&&!n?(i.push(t),e.expanded=!1):!s&&n&&(o=o.add([t]),e.expanded=!0)}),i.forEach(e=>{r=c.collapse(e,r),o=o.delete([e]),l=l.delete([e])}),{renderedData:r,expandingKeys:o,expandedToggleKeys:n,expandedSkeletonKeys:l,toCollapse:i}}return{toCollapse:i}}static _findIndex(e,t){for(let s=0;s<e.length;s++)if(r.KeyUtils.equals(t,e[s].key))return s;return-1}_unregisterScrollHandler(){this._getScrollEventElement().removeEventListener("scroll",this.scrollListener)}_registerScrollHandler(){let e=this._getScrollEventElement();this._unregisterScrollHandler(),e.addEventListener("scroll",this.scrollListener)}scrollListener(){var e=this;this._ticking||(window.requestAnimationFrame((function(){e._updateScrollPosition(),e._ticking=!1})),this._ticking=!0)}_updateScrollPosition(){let e={},t=this._getScroller().scrollTop,s=this._findClosestElementToTop(t);if(e.y=t,null!=s){let t=s.elem;e.offsetY=s.offsetY,e.key=t.getAttribute("key"),this._isTreeData()&&t.classList.contains("oj-stream-list-item")?e.parentKey=this._getParentKey(t):e.parentKey=null}this._updateProperty("scrollPosition",e)}_syncScrollTopWithProps(){let e,t=this.props.scrollPosition;const s=t.key;if(s){const n=t.parentKey,o=this._getItemByKey(s,n);if(null==o)return;{let t=this.root;e=o.offsetTop-t.offsetTop}const r=t.offsetY;isNaN(r)||(e+=r)}else{const s=t.y;if(isNaN(s))return;e=s}e>this._getScroller().scrollHeight||(this._getScroller().scrollTop=e)}_getParentKey(e){for(;e;){if(e.classList.contains("oj-stream-list-group"))return e.key;e=e.previousElementSibling}return null}_getItemByKey(e,t){var s=this.root.querySelectorAll(".oj-stream-list-item, .oj-stream-list-group");for(let n=0;n<s.length;n++){let o=s[n];if(o===e&&(null==t||this._getParentKey(o)===t))return o}}_getScrollEventElement(){var e=this.props.scrollPolicyOptions.scroller;return null!=e?e===document.body||e===document.documentElement?window:e:this.getRootElement()}_getScroller(){var e=this.props.scrollPolicyOptions.scroller;return null!=e?e:this.getRootElement()}_findClosestElementToTop(e){var t=this.root.querySelectorAll(".oj-stream-list-item, .oj-stream-list-group");if(null==t||0===t.length)return null;let s=this.root.offsetTop,n=Math.max(e,0),o=0-s,r=n,l=0,i=t[l],a=!1,h={elem:i,offsetY:r};for(;!a&&l>=0&&l<t.length&&(i=t[l],o=i.offsetTop-s,r=Math.abs(n-o),a=r<1||n<=o,!a);)h={elem:i,offsetY:r},l+=1;return h}_getExpandSkeletonsForKey(e){let t=[];return this.getRootElement().querySelectorAll(".oj-stream-list-child-skeleton").forEach((function(s){s.getAttribute("key")==e&&t.push(s)})),t}isAvailable(){return null!=this.contentHandler}getCurrentItem(){return this.currentKey}setCurrentItem(e){this.currentKey=e}getData(){return this.state.renderedData}setData(e){this.updateState({renderedData:e})}updateData(e){this.updateState(function(t){return e(t.renderedData,t.expandingKeys)}.bind(this))}getExpanded(){return this.props.expanded}setExpanded(e){this._updateProperty("expanded",e)}updateExpand(e){this.updateState(function(t,s){return e(t.renderedData,t.expandedSkeletonKeys,t.expandingKeys,s.expanded)}.bind(this))}getExpandingKeys(){return this.state.expandingKeys}setExpandingKeys(e){this.updateState({expandingKeys:e})}updateExpandingKeys(e){this.updateState((function(t){return{expandingKeys:t.expandingKeys.add([e])}}))}getSkeletonKeys(){return this.state.expandedSkeletonKeys}setSkeletonKeys(e){this.updateState({expandedSkeletonKeys:e})}updateSkeletonKeys(e){this.updateState((function(t){return{expandedSkeletonKeys:t.expandedSkeletonKeys.add([e])}}))}getOutOfRangeData(){return this.state.outOfRangeData}setOutOfRangeData(e){this.updateState({outOfRangeData:e})}getItemRenderer(){return this.props.itemTemplate}getItemStyleClass(){return"oj-stream-list-item"}getGroupRenderer(){return this.props.groupTemplate}getGroupStyleClass(){return"oj-stream-list-group"}_handleTouchOrClickEvent(e){let t=e.target,s=t.closest(".oj-stream-list-item, .oj-stream-list-group");s&&(this._isFocusable(t,s)?(this._updateCurrentItemAndFocus(s,!1),this._enterActionableMode(t)):this._updateCurrentItemAndFocus(s,!0))}_isFocusable(e,t){return this._isInputElement(e)||this._isInsideFocusableElement(e,t)}_isInputElement(e){return null!=e.nodeName.match(/^INPUT|SELECT|OPTION|TEXTAREA/)&&!e.readOnly}_isInsideFocusableElement(e,t){let s=!1;for(;e!==t&&null!=e;){if(e.classList.contains("oj-form-control")||this._isInFocusableElementsList(e,t)){e.readonly||e.disabled||(s=!0);break}e=e.parentNode}return s}_isInFocusableElementsList(e,t){let n=!1;return s.getFocusableElementsIncludingDisabled(t).forEach((function(t){t===e&&(n=!0)})),n}_resetFocus(e){this.actionableMode&&this._exitActionableMode(!1),e.classList.remove("oj-focus"),e.tabIndex=-1}_setFocus(e,t){e.tabIndex=0,t&&(e.classList.add("oj-focus"),e.focus())}_updateCurrentItemAndFocus(e,t){let s=this.currentItem,n=e;this._resetFocus(s),this._setFocus(n,t),this.currentItem=n,this.setCurrentItem(n.key)}_isInViewport(e){let t=e.offsetTop,s=this._getScroller().scrollTop;return t>=s&&t<=s+this.height}_restoreCurrentItem(e){if(null!=this.currentKey)for(let t=0;t<e.length;t++)if(r.KeyUtils.equals(e[t].key,this.currentKey)){const s=e[t];if(this.restoreFocus&&this._isInViewport(s))return void this._updateCurrentItemAndFocus(s,!0);this._setFocus(s,!1),this.currentItem=s;break}this.restoreFocus=!1}_disableAllTabbableElements(e){e.forEach(e=>{n.getContext(e).getBusyContext().whenReady().then((function(){s.disableAllFocusableElements(e,!0)}))})}_enterActionableMode(e){if(this.actionableMode=!0,this.currentItem){const t=s.enableAllFocusableElements(this.currentItem,!0);null==e&&t&&t.length>0&&t[0].focus()}}_exitActionableMode(e){this.actionableMode=!1,this.currentItem&&(s.disableAllFocusableElements(this.currentItem,!0),this._setFocus(this.currentItem,e))}},e.StreamList.collapse=(e,t)=>{let s=t.value.data,n=t.value.metadata,o=c._findIndex(n,e);if(o>-1){let e=c._getLocalDescendentCount(n,o);s.splice(o+1,e),n.splice(o+1,e)}return{value:{data:s,metadata:n},done:t.done}},e.StreamList._getLocalDescendentCount=(e,t)=>{let s=0,n=e[t].treeDepth,o=e.length;for(let r=t+1;r<o;r++){if(!(e[r].treeDepth>n))return s;s+=1}return s},e.StreamList.metadata={extension:{_DEFAULTS:class{constructor(){this.data=null,this.expanded=new l.KeySetImpl,this.scrollPolicy="loadMoreOnScroll",this.scrollPolicyOptions={fetchSize:25,maxCount:500,scroller:null},this.scrollPosition={y:0}}}},properties:{data:{type:"object|null",value:null},expanded:{type:"object",writeback:!0,readOnly:!1},scrollPolicy:{type:"string",enumValues:["loadAll","loadMoreOnScroll"],value:"loadMoreOnScroll"},scrollPolicyOptions:{type:"object",properties:{fetchSize:{type:"number",value:25},maxCount:{type:"number",value:500},scroller:{type:"Element|null",value:null}}},scrollPosition:{type:"object",properties:{y:{type:"number",value:0},key:{type:"any"},offsetY:{type:"number"},parentKey:{type:"any"}},writeback:!0,readOnly:!1}},slots:{groupTemplate:{},itemTemplate:{}}},u([t.listener()],e.StreamList.prototype,"_handleFocusIn",null),u([t.listener()],e.StreamList.prototype,"_handleFocusOut",null),u([t.listener()],e.StreamList.prototype,"_handleClick",null),u([t.listener()],e.StreamList.prototype,"_handleKeyDown",null),u([t.listener({passive:!0})],e.StreamList.prototype,"_touchStartHandler",null),u([t.listener()],e.StreamList.prototype,"scrollListener",null),e.StreamList=c=u([t.customElement("oj-stream-list")],e.StreamList),Object.defineProperty(e,"__esModule",{value:!0})}));